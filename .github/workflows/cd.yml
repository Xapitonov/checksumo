name: CD

on:
  push:
    tags:
      - 'v*'

jobs:
  cd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Build package
        uses: dawidd6/action-debian-package@v1
      - name: Create release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{github.token}}
          tag: ${{github.ref}}
          file: '*.deb'
          file_glob: true
          overwrite: true
      - name: Scan packages
        run: |
          sudo apt update
          sudo apt install -yq dpkg-dev
          dpkg-scanpackages . > Packages
      - name: Create repo
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{github.token}}
          tag: repo
          file: '*(*.deb|Packages)'
          release_name: APT repository
          file_glob: true
          overwrite: true
